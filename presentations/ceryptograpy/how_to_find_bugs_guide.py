"""
🔍 מדריך לתלמיד: איך לזהות באגים דרך בדיקות תוכנה
======================================================

מסמך זה מראה בדיוק איזה בדיקות חושפות איזה באגים,
ואיך תלמיד יכול לגלות חולשות אבטחה בקוד.
"""

# ============================================================================
# באג #1: סיסמאות עם תווים זהים
# ============================================================================

print("="*80)
print("🐛 באג #1: חולשת אבטחה - סיסמה עם תווים זהים")
print("="*80)

from secret_cipher import create_key_from_password, encrypt_message, decrypt_message

print("\n📋 איך תלמיד יכול לגלות את הבאג הזה?")
print("-" * 80)

print("\n✅ בדיקה #1.1: בדיקת מקרי קצה (Edge Cases)")
print("עקרון: בדוק מה קורה עם קלטים קיצוניים\n")

print("נסה סיסמאות 'קיצוניות':")
test_passwords = ["A", "AA", "AAA", "AAAA", "AAAAA"]

for pwd in test_passwords:
    try:
        key = create_key_from_password(pwd)
        print(f"  סיסמה: '{pwd:6}' → מפתח: {key}")
    except Exception as e:
        print(f"  סיסמה: '{pwd:6}' → שגיאה: {e}")

print("\n💡 מה תלמיד צריך לשים לב?")
print("  ❗ כל הסיסמאות מייצרות מפתח רגיל: [0,1,2,3,...]")
print("  ❗ זה אומר שאין ערבוב אמיתי!")
print("  ❗ ההצפנה תהיה חלשה מאוד")

print("\n" + "="*40)
print("🔬 ניסוי מעשי:")
print("="*40)

message = "ATTACK NOW"
password = "AAAA"

encrypted = encrypt_message(message, password)
print(f"\nהודעה מקורית: {message}")
print(f"סיסמה: {password}")
print(f"הודעה מוצפנת: {encrypted}")

print("\n❓ שאלות לתלמיד:")
print("1. האם אתה רואה חלקים מההודעה המקורית בהצפנה?")
print("2. האם ההצפנה נראית 'מעורבבת' מספיק?")
print("3. האם תוקף יכול לנחש מילים?")

print("\n✅ בדיקה #1.2: השוואת מפתחות מסיסמאות שונות")
print("עקרון: בדוק שסיסמאות שונות מייצרות מפתחות שונים\n")

passwords_to_compare = ["AAA", "BBB", "CCC", "111", "222"]
keys = {}

for pwd in passwords_to_compare:
    key = create_key_from_password(pwd)
    keys[pwd] = key
    print(f"  '{pwd}' → {key}")

print("\n💡 מה תלמיד צריך לגלות?")
print("  ❗ כל הסיסמאות מייצרות את אותו המפתח!")
print("  ❗ זו בעיית אבטחה חמורה (key collision)")

# בדיקה אוטומטית
unique_keys = set(tuple(v) for v in keys.values())
print(f"\n📊 סטטיסטיקה: {len(passwords_to_compare)} סיסמאות → {len(unique_keys)} מפתח ייחודי")

if len(unique_keys) < len(passwords_to_compare):
    print("  🚨 בעיה! סיסמאות שונות מייצרות אותו מפתח!")


# ============================================================================
# באג #2: התנגשות מפתחות
# ============================================================================

print("\n\n" + "="*80)
print("🐛 באג #2: התנגשות מפתחות - סיסמאות שונות לחלוטין → אותו מפתח")
print("="*80)

print("\n✅ בדיקה #2.1: בדיקת קלטים בלתי צפויים (Unexpected Inputs)")
print("עקרון: נסה קלטים מגוונים ובדוק שהתוצאות שונות\n")

diverse_passwords = [
    "ABC",    # אותיות רגילות
    "123",    # מספרים
    "AAA",    # תווים זהים
    "XYZ",    # אותיות אחרות
    "999",    # מספרים אחרים
]

print("בדיקת סיסמאות מגוונות:")
key_groups = {}

for pwd in diverse_passwords:
    key = create_key_from_password(pwd)
    key_tuple = tuple(key)
    
    if key_tuple not in key_groups:
        key_groups[key_tuple] = []
    key_groups[key_tuple].append(pwd)
    
    print(f"  '{pwd}' → {key}")

print("\n💡 ניתוח:")
for key_tuple, pwds in key_groups.items():
    if len(pwds) > 1:
        print(f"  🚨 התנגשות! המפתח {list(key_tuple)} מיוצר על ידי:")
        for pwd in pwds:
            print(f"     - '{pwd}'")

print("\n✅ בדיקה #2.2: בדיקה עם Parametrize")
print("עקרון: הרץ אותה בדיקה עם הרבה ערכים שונים\n")

print("קוד לדוגמה ב-pytest:")
print("""
@pytest.mark.parametrize("password1,password2", [
    ("AAA", "BBB"),
    ("111", "222"),
    ("XXX", "YYY"),
])
def test_different_passwords_different_keys(password1, password2):
    key1 = create_key_from_password(password1)
    key2 = create_key_from_password(password2)
    
    # סיסמאות שונות צריכות לייצר מפתחות שונים!
    assert key1 != key2, f"Collision: {password1} and {password2} produce same key!"
""")

print("\n🔬 הרצה מעשית של הבדיקה:")
test_pairs = [
    ("AAA", "BBB"),
    ("111", "222"),
    ("XXX", "YYY"),
]

for pwd1, pwd2 in test_pairs:
    key1 = create_key_from_password(pwd1)
    key2 = create_key_from_password(pwd2)
    
    if key1 == key2:
        print(f"  ❌ נכשל: '{pwd1}' ו-'{pwd2}' → אותו מפתח {key1}")
    else:
        print(f"  ✅ עבר: '{pwd1}' ו-'{pwd2}' → מפתחות שונים")


# ============================================================================
# באג #3: דליפת מידע דרך אורך ההצפנה
# ============================================================================

print("\n\n" + "="*80)
print("🐛 באג #3: דליפת מידע - אורך ההצפנה חושף מידע על ההודעה")
print("="*80)

print("\n✅ בדיקה #3.1: בדיקת גבולות (Boundary Testing)")
print("עקרון: בדוק קלטים באורכים שונים ובדוק דפוסים\n")

password = "KEY"
test_messages = [
    "A",           # 1 תו
    "AB",          # 2 תווים
    "ABC",         # 3 תווים
    "ABCD",        # 4 תווים
    "ABCDE",       # 5 תווים
    "ABCDEFGHIJ",  # 10 תווים
    "A" * 20,      # 20 תווים
    "A" * 50,      # 50 תווים
]

print("בדיקת אורכי הודעה:")
print(f"{'אורך מקורי':^15} | {'אורך מוצפן':^15} | {'יחס':^10}")
print("-" * 45)

length_ratios = []
for msg in test_messages:
    encrypted = encrypt_message(msg, password)
    ratio = len(encrypted) / len(msg) if len(msg) > 0 else 0
    length_ratios.append((len(msg), len(encrypted)))
    print(f"{len(msg):^15} | {len(encrypted):^15} | {ratio:^10.2f}")

print("\n💡 מה תלמיד צריך לשים לב?")
print("  ❗ יש קשר ישיר בין אורך ההודעה לאורך ההצפנה")
print("  ❗ תוקף יכול לחשב בערך את אורך ההודעה המקורית")
print("  ❗ זה חושף מידע על סוג ההודעה")

print("\n🔬 דוגמה מעשית:")
short_msg = "YES"
long_msg = "THIS IS A VERY LONG SECRET MESSAGE"

encrypted_short = encrypt_message(short_msg, password)
encrypted_long = encrypt_message(long_msg, password)

print(f"\nהודעה קצרה: '{short_msg}' → מוצפן באורך {len(encrypted_short)}")
print(f"הודעה ארוכה: '{long_msg}' → מוצפן באורך {len(encrypted_long)}")
print(f"\n❓ האם תוקף יכול להבדיל בין תשובה קצרה להודעה ארוכה? כן!")


# ============================================================================
# באג #4: רווחים מיותרים בהודעות קצרות
# ============================================================================

print("\n\n" + "="*80)
print("🐛 באג #4: חשיפת מידע - הודעות קצרות עם רווחים מרובים")
print("="*80)

print("\n✅ בדיקה #4.1: בדיקת תרחישי קצה מורכבים")
print("עקרון: בדוק מצבים שבהם הודעה קצרה מאוד + סיסמה ארוכה\n")

message = "X"  # הודעה קצרה מאוד
passwords_long = [
    "SHORTKEY",
    "VERYLONGPASSWORD",
    "EXTREMELYLONGPASSWORDHERE"
]

print("הודעה קצרה עם סיסמאות באורכים שונים:")
for pwd in passwords_long:
    encrypted = encrypt_message(message, pwd)
    spaces = encrypted.count(" ")
    non_spaces = len(encrypted) - spaces
    
    print(f"\nסיסמה: '{pwd}' (אורך: {len(pwd)})")
    print(f"  מוצפן: '{encrypted}'")
    print(f"  רווחים: {spaces}/{len(encrypted)} ({spaces/len(encrypted)*100:.1f}%)")
    print(f"  תווים אחרים: {non_spaces}")
    
    if spaces > len(encrypted) * 0.7:
        print(f"  🚨 בעיה! יותר מ-70% רווחים - חושף שההודעה קצרה!")

print("\n💡 מה תלמיד צריך לגלות?")
print("  ❗ הודעה קצרה + סיסמה ארוכה = הרבה רווחים")
print("  ❗ תוקף יכול לספור רווחים ולדעת שההודעה קצרה")
print("  ❗ זה חושף מידע רגיש")


# ============================================================================
# באג #5: דפוסים צפויים עם תווים חוזרים
# ============================================================================

print("\n\n" + "="*80)
print("🐛 באג #5: דפוסים צפויים - תווים חוזרים במפתח")
print("="*80)

print("\n✅ בדיקה #5.1: בדיקת קלטים עם דפוסים חוזרים")
print("עקרון: נסה סיסמאות עם תבניות חוזרות ובדוק את המפתח\n")

pattern_passwords = [
    ("ABCABC", "דפוס ABC חוזר פעמיים"),
    ("ABABAB", "דפוס AB חוזר 3 פעמים"),
    ("AABBCC", "כל תו חוזר פעמיים"),
    ("123123", "דפוס 123 חוזר פעמיים"),
]

print("בדיקת סיסמאות עם תבניות חוזרות:")
for pwd, description in pattern_passwords:
    key = create_key_from_password(pwd)
    print(f"\nסיסמה: '{pwd}' - {description}")
    print(f"  מפתח: {key}")
    
    # בדיקה אם המפתח צפוי
    is_sequential = all(key[i] < key[i+1] for i in range(len(key)-1))
    has_pattern = len(set(key[:len(key)//2])) == len(key)//2
    
    if is_sequential:
        print(f"  🚨 המפתח רציף לחלוטין - צפוי מאוד!")
    
    # ניתוח הדפוס
    half = len(key) // 2
    if len(key) % 2 == 0:
        first_half = key[:half]
        second_half = key[half:]
        pattern_found = all(second_half[i] - first_half[i] == half for i in range(half))
        if pattern_found:
            print(f"  🚨 דפוס מצוא: חצי ראשון + {half} = חצי שני")

print("\n💡 מה תלמיד צריך להבין?")
print("  ❗ תווים חוזרים יוצרים דפוסים צפויים במפתח")
print("  ❗ תוקף שמזהה את הדפוס יכול לנחש את המפתח")
print("  ❗ זה מקל על שבירת ההצפנה")


# ============================================================================
# סיכום: איך תלמיד מזהה באגים?
# ============================================================================

print("\n\n" + "="*80)
print("📚 סיכום: איך תלמיד מזהה באגים בקוד?")
print("="*80)

print("""
🎯 אסטרטגיות לגילוי באגים:

1️⃣  בדיקת מקרי קצה (Edge Cases)
   ✓ נסה קלטים קיצוניים: ריקים, קצרים מאוד, ארוכים מאוד
   ✓ נסה קלטים 'מוזרים': תווים זהים, תווים חוזרים
   ✓ שאל: מה הדבר הכי קיצוני שיכול להיכנס?

2️⃣  בדיקת קלטים בלתי צפויים (Unexpected Inputs)
   ✓ נסה קלטים שלא 'הגיוניים': "AAA", "111", "ZZZZZ"
   ✓ נסה שילובים מוזרים: הודעה קצרה + סיסמה ארוכה
   ✓ שאל: מה אם משתמש יזין משהו לא רגיל?

3️⃣  בדיקת גבולות (Boundary Testing)
   ✓ בדוק ערכי מינימום ומקסימום
   ✓ בדוק מה קורה סביב הגבולות (n-1, n, n+1)
   ✓ שאל: מה המינימום והמקסימום המותרים?

4️⃣  השוואות וזיהוי דפוסים
   ✓ הרץ אותה פעולה עם קלטים שונים והשווה תוצאות
   ✓ חפש דפוסים חוזרים או תוצאות זהות
   ✓ שאל: האם קלטים שונים צריכים לתת תוצאות זהות?

5️⃣  בדיקות רנדומליות (Random Testing)
   ✓ הרץ מאות בדיקות עם קלטים אקראיים
   ✓ חפש התנהגות לא עקבית
   ✓ שאל: האם התוצאות יציבות וצפויות?

6️⃣  חשיבה כתוקף (Attacker Mindset)
   ✓ שאל: איך הייתי מנסה לשבור את זה?
   ✓ חפש דליפות מידע (אורך, תבניות, רווחים)
   ✓ בדוק אם יש מידע שלא צריך להיחשף

7️⃣  קריאת קוד ביקורתית
   ✓ עבור על הקוד שורה אחר שורה
   ✓ שאל: מה קורה במקרים מיוחדים?
   ✓ חפש הנחות שהקוד עושה (ולא בודק)
""")

print("\n" + "="*80)
print("🔬 תהליך מומלץ לגילוי באגים:")
print("="*80)

print("""
שלב 1: הבנת הקוד
  □ קרא את הקוד ותבין מה הוא אמור לעשות
  □ זהה את הפונקציות העיקריות
  □ זהה את הולידציות (בדיקות תקינות)

שלב 2: תכנון בדיקות
  □ רשום רשימת מקרי קצה
  □ רשום רשימת קלטים לא שגרתיים
  □ חשוב על מה יכול להשתבש

שלב 3: כתיבת בדיקות
  □ כתוב בדיקות למקרי הקצה
  □ כתוב בדיקות לקלטים בלתי צפויים
  □ כתוב בדיקות השוואה (קלטים שונים → תוצאות שונות?)

שלב 4: ניתוח תוצאות
  □ הרץ את הבדיקות
  □ בדוק אם יש דפוסים מוזרים
  □ שאל: האם התוצאות הגיוניות?

שלב 5: תיעוד הבאגים
  □ תעד מה מצאת
  □ הסבר למה זה באג
  □ הצע תיקון אפשרי
""")

print("\n" + "="*80)
print("💡 טיפים מעשיים לתלמידים:")
print("="*80)

print("""
✅ תמיד שאל: "מה הדבר הכי מוזר שיכול לקרות?"
✅ אל תניח שהקוד עובד - בדוק הכל!
✅ קלט לא תקין הוא לא שגיאה - זה הזדמנות למצוא באג
✅ אם שתי סיסמאות שונות נותנות אותו תוצאה - זו בעיה!
✅ אם אורך הפלט תלוי באורך הקלט - זו דליפת מידע
✅ אם ההצפנה נראית "פשוטה מדי" - כנראה שהיא חלשה
✅ תכתוב בדיקות לפני שאתה מתקן - כדי לוודא שהתיקון עובד

❌ אל תניח שהקוד בטוח כי הוא "נראה טוב"
❌ אל תוותר אחרי בדיקה אחת - נסה הרבה מקרים
❌ אל תבדוק רק את המקרים ה"רגילים" - הבאגים במקרים המיוחדים
""")

print("\n" + "="*80)
print("🎓 שאלות שעוזרות לזהות באגים:")
print("="*80)

print("""
לפני כתיבת בדיקה, שאל את עצמך:

1. מה המינימום והמקסימום?
   - מה קורה עם קלט באורך 0? באורך 1? באורך מאסיבי?

2. מה קורה עם קלטים זהים?
   - מה אם כל התווים בסיסמה זהים?
   - מה אם ההודעה היא רק רווחים?

3. מה קורה עם קלטים חוזרים?
   - מה אם הסיסמה היא "ABCABC"?
   - האם זה יוצר דפוס צפוי?

4. האם קלטים שונים יכולים לתת אותה תוצאה?
   - "AAA" ו-"BBB" צריכים לתת תוצאות שונות
   - אם לא - זו בעיה!

5. מה המערכת חושפת מידע שלא צריך?
   - האם אורך ההצפנה חושף מידע?
   - האם יש דפוסים שאפשר לזהות?

6. מה קורה במקרים "מוזרים"?
   - הודעה קצרה + סיסמה ארוכה?
   - סיסמה עם תווים מיוחדים?
""")

print("\n" + "="*80)
print("✅ סיום - המפתח להצלחה:")
print("="*80)

print("""
הדרך הטובה ביותר לזהות באגים היא:

  🔍 סקרנות - תמיד שאל "מה אם?"
  🧪 ניסויים - נסה הרבה מקרים שונים
  🤔 חשיבה ביקורתית - אל תקבל כלום כמובן מאליו
  📝 תיעוד - כתוב מה מצאת ולמה זה בעיה
  💪 התמדה - לפעמים הבאג מסתתר במקום לא צפוי

זכור: מטרת בדיקות התוכנה היא למצוא באגים, לא להוכיח שהקוד עובד!
""")

print("\n" + "="*80)
print("🎯 סיום הדמו - המערכת מוכנה לשימוש חינוכי")
print("="*80)
